export async function onRequest(e){const{request:s}=e;if("OPTIONS"===s.method)return new Response(null,{status:204,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type","Access-Control-Max-Age":"86400"}});try{const n="https://challenges.cloudflare.com/turnstile/v0/siteverify",o=e.env.TURNSTILE_SECRET_KEY||"0x4AAAAAABfltL9Uqbz7lyBC4Dydi485j7Y";if("POST"!==s.method)return new Response(JSON.stringify({success:!1,error:"Method not allowed"}),{status:405,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*"}});const r=await s.json(),{token:t}=r;if(!t)return new Response(JSON.stringify({success:!1,error:"Missing token"}),{status:400,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*"}});const i=new URLSearchParams;i.append("secret",o),i.append("response",t);const c=s.headers.get("cf-connecting-ip")||s.headers.get("x-forwarded-for");c&&i.append("remoteip",c);const a=await fetch(n,{method:"POST",body:i,headers:{"Content-Type":"application/x-www-form-urlencoded"}}),l=await a.json();return l.success?new Response(JSON.stringify({success:!0}),{headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*"}}):(console.error("Turnstile verification failed:",l),new Response(JSON.stringify({success:!1,error:"Verification failed",details:l["error-codes"]}),{status:400,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*"}}))}catch(e){return console.error("Error verifying Turnstile token:",e),new Response(JSON.stringify({success:!1,error:"Internal server error"}),{status:500,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*"}})}}